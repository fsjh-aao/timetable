<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ë™≤Ë°®Êü•Ë©¢Á≥ªÁµ±</title>
    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Noto+Sans+TC:wght@300;400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- GAS API Configuration -->
    <script>
        // [IMPORTANT] This ID points to the original GAS project script
        const GAS_API_URL = 'https://script.google.com/macros/s/AKfycbySt-5WOOMa6B3Wh8H3Wk4pc8jyjzBVNfcklXDzTRWv7wXTbG86Jl2frDTclCMTOz1-/exec';

        // Mock google.script.run for compatibility
        window.google = window.google || {};
        window.google.script = window.google.script || {};

        window.google.script.run = {
            withSuccessHandler: function (callback) {
                return new Proxy({}, {
                    get: function (target, prop) {
                        return function (...args) {
                            console.log(`[Adapter] Call: ${prop}`, args);
                            if (prop === 'getFullSystemSync') {
                                // Real network call
                                fetch(`${GAS_API_URL}?api=true`)
                                    .then(res => res.json())
                                    .then(data => {
                                        console.log('[Adapter] Data Received', data);
                                        callback(data);
                                    })
                                    .catch(err => {
                                        console.error('[Adapter] Error', err);
                                        if (window.google.script.run.failureHandler) window.google.script.run.failureHandler(err);
                                    });
                            } else {
                                console.warn(`[Adapter] Function ${prop} should be handled locally.`);
                                // If some function slips through local cache, we ignore it here 
                                // because we rewritten fetchWithCache to handle everything locally.
                            }
                        }
                    }
                });
            },
            withFailureHandler: function (callback) {
                this.failureHandler = callback;
                return this;
            }
        };

        window.google.script.history = {
            push: function (s, p, page) {
                const url = new URL(window.location);
                url.searchParams.set('page', page);
                if (p) Object.keys(p).forEach(k => url.searchParams.set(k, p[k]));
                window.history.pushState(s, '', url);
            },
            setChangeHandler: function (cb) {
                window.addEventListener('popstate', () => {
                    const params = {};
                    new URL(window.location).searchParams.forEach((val, key) => params[key] = val);
                    cb({ location: { parameter: params } });
                });
            }
        };
    </script>

    <!-- Styles Merged -->
    <style>
        :root {
            --primary-color: #2980b9;
            --secondary-color: #2c3e50;
            --accent-color: #3498db;
            --bg-color: #f0f3f5;
            --surface-color: #ffffff;
            --text-color: #3c4043;
            --subtle-gray: #dcdde1;
            --tt-header-bg: #dfe6e9;

            /* v6.1 Theme */
            --brand-primary: #2563eb;
            --brand-dark: #0f172a;
            --brand-light: #eff6ff;
            --glass-bg: rgba(255, 255, 255, 0.88);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        html,
        body {
            -webkit-text-size-adjust: none !important;
            text-size-adjust: none !important;
            margin: 0;
            padding: 0;
            background-color: #f8fafc;
            font-family: 'Plus Jakarta Sans', 'Noto Sans TC', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Layout & Components */
        .page-view {
            display: none;
            width: 100%;
            flex-grow: 1;
        }

        .page-view.active {
            display: block;
        }

        .container {
            max-width: 1200px;
            margin: 10px auto;
            padding: 15px 30px;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
        }

        .global-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f1f5f9;
        }

        .nav-links {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .nav-links a {
            text-decoration: none;
            color: #3b82f6;
            font-weight: 500;
            cursor: pointer;
        }

        .nav-links span {
            color: #ddd;
        }

        .nav-links .current {
            color: #94a3b8;
            pointer-events: none;
            font-weight: bold;
        }

        /* Home Styles */
        .home-hero {
            height: 320px;
            background: linear-gradient(135deg, #1e40af, #0f172a);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: #fff;
            text-align: center;
            margin-bottom: 40px;
            clip-path: ellipse(150% 100% at 50% 0%);
        }

        .home-title {
            font-size: 2.8rem;
            font-weight: 800;
            margin: 0;
        }

        .home-subtitle {
            margin-top: 10px;
            font-size: 1.15rem;
            opacity: 0.85;
        }

        .home-grid {
            max-width: 950px;
            margin: -90px auto 60px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            padding: 0 20px;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border-radius: 28px;
            padding: 35px 25px;
            text-align: center;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.05);
            cursor: pointer;
            transition: transform 0.3s;
        }

        .feature-card:hover {
            transform: translateY(-8px);
        }

        .card-icon {
            width: 70px;
            height: 70px;
            background: #eff6ff;
            color: #2563eb;
            border-radius: 18px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
        }

        .card-title {
            font-size: 1.5rem;
            color: #0f172a;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .card-desc {
            color: #64748b;
        }

        /* Buttons & Inputs */
        .nav-btn {
            background: #fff;
            color: #3b82f6;
            border: 1.5px solid #3b82f6;
            padding: 4px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.95em;
            white-space: nowrap;
        }

        .nav-btn.active,
        .nav-btn:hover {
            background: #3b82f6;
            color: white;
        }

        .nav-rows-container {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .nav-row {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding-bottom: 2px;
        }

        .teacher-search-box {
            display: flex;
            align-items: center;
            border: 1px solid #cbd5e1;
            border-radius: 20px;
            padding: 0 10px;
            background: white;
            height: 32px;
        }

        .teacher-search-input {
            border: none;
            outline: none;
            margin-left: 6px;
            font-size: 0.9em;
            width: 120px;
        }

        /* Table Styles */
        .teacher-table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
        }

        .teacher-table th {
            background: #f1f5f9;
            padding: 10px;
            color: #475569;
        }

        .teacher-table td {
            border-bottom: 1px solid #f1f5f9;
            padding: 10px;
            color: #1e293b;
        }

        .teacher-table tr:hover {
            background: #f8fafc;
        }

        /* Timetable */
        .timetable-table {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            border-collapse: collapse;
            border: 2px solid #0f172a;
            table-layout: fixed;
        }

        .timetable-table th {
            background: #f1f5f9;
            border: 1px solid #0f172a;
            height: 40px;
        }

        .timetable-table td {
            border: 1px solid #cbd5e1;
            height: 50px;
            text-align: center;
            vertical-align: middle;
            padding: 2px;
        }

        .period-label {
            background: #ebf2f6;
            width: 60px;
            font-weight: bold;
        }

        .subject-name {
            font-weight: 700;
            display: block;
            font-size: 1.1em;
        }

        .link-text {
            color: #3b82f6;
            font-size: 0.9em;
            cursor: pointer;
            display: block;
        }

        .timetable-table-wrap {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Detail Layout */
        .detail-wrapper {
            display: flex;
            gap: 12px;
            margin: 10px auto;
            max-width: 1200px;
        }

        .col-cats {
            width: 104px;
            flex-shrink: 0;
            background: #0f172a;
            color: #f1f5f9;
            border-radius: 12px;
            padding: 10px 0;
        }

        .cat-btn {
            padding: 8px 15px;
            cursor: pointer;
            font-size: 1.05em;
            border-left: 4px solid transparent;
        }

        .cat-btn.active {
            background: #1e293b;
            border-left-color: #3b82f6;
            font-weight: bold;
        }

        .cat-group {
            padding: 5px 15px;
            font-size: 0.75em;
            color: #64748b;
            font-weight: bold;
            margin-top: 5px;
        }

        .col-list {
            width: 220px;
            flex-shrink: 0;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 100px);
        }

        .list-search-box {
            padding: 10px;
            border-bottom: 1px solid #f1f5f9;
        }

        .list-search-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-sizing: border-box;
        }

        .list-scroll-area {
            overflow-y: auto;
            flex-grow: 1;
        }

        .list-item {
            padding: 8px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f8fafc;
        }

        .list-item:hover {
            background: #f1f5f9;
        }

        .list-item.active {
            background: #eff6ff;
            border-left: 3px solid #3b82f6;
        }

        .col-main {
            flex-grow: 1;
            background: #fff;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
        }

        /* Class Grid */
        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 8px;
        }

        .class-btn {
            border: 1px solid #e2e8f0;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            background: #f0f9ff;
            color: #0369a1;
            font-weight: 500;
        }

        .class-btn.active {
            background: #0369a1;
            color: white;
        }

        .grade-section {
            margin-bottom: 15px;
            padding: 10px;
            background: #fff;
            border-radius: 8px;
            border: 1px solid #f1f5f9;
        }

        .grade-title {
            font-weight: bold;
            margin-bottom: 8px;
            border-left: 4px solid #3b82f6;
            padding-left: 8px;
        }

        .col-class-nav {
            width: 200px;
            flex-shrink: 0;
            background: white;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .class-tabs {
            display: flex;
            border-bottom: 1px solid #e2e8f0;
        }

        .class-tab {
            flex: 1;
            text-align: center;
            padding: 10px;
            cursor: pointer;
            background: #f8fafc;
        }

        .class-tab.active {
            background: white;
            border-bottom: 2px solid #3b82f6;
            font-weight: bold;
        }

        .class-btn-mini {
            padding: 6px;
            margin: 4px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
        }

        .class-btn-mini:hover {
            background: #f1f5f9;
        }

        .class-btn-mini.active {
            bg: #eff6ff;
            color: #2563eb;
            font-weight: bold;
        }

        /* Loader */
        #app-loader {
            position: fixed;
            inset: 0;
            background: #0f172a;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: white;
            transition: opacity 0.5s;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #334155;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Media Queries */
        @media (max-width: 768px) {
            .detail-wrapper {
                flex-direction: column;
            }

            .col-cats,
            .col-list,
            .col-class-nav {
                width: 100%;
                height: auto;
                max-height: 180px;
            }

            .col-main {
                padding: 10px;
            }

            .timetable-table th,
            .timetable-table td {
                padding: 2px;
                font-size: 0.85em;
            }

            .container {
                padding: 10px;
            }
        }

        @media print {

            .global-nav,
            .col-cats,
            .col-list,
            .col-class-nav,
            .print-btn,
            .home-hero {
                display: none !important;
            }

            .col-main,
            .container {
                width: 100% !important;
                border: none !important;
                margin: 0 !important;
                padding: 0 !important;
                box-shadow: none !important;
            }

            .detail-wrapper {
                display: block !important;
            }
        }
    </style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="app-loader">
        <div class="spinner"></div>
        <div style="margin-top:20px; font-weight:bold;">Á≥ªÁµ±ËºâÂÖ•‰∏≠...</div>
        <div style="font-size:0.8em; color:#94a3b8; margin-top:5px;">Ê≠£Âú®ÂêåÊ≠•ÊúÄÊñ∞Ë™≤Ë°®Ë≥áÊñô</div>
    </div>

    <!-- App Container -->
    <div id="app">
        <!-- Index Page -->
        <div id="page-index" class="page-view active">
            <div class="home-hero">
                <h1 class="home-title" id="home-school-name">Ë™≤Ë°®Êü•Ë©¢Á≥ªÁµ±</h1>
                <div class="home-subtitle">Êô∫ÊÖß„ÄÅÂç≥ÊôÇ„ÄÅÁ≤æÊ∫ñÁöÑÊ†°ÂúíË™≤ÂãôÊ†∏ÂøÉÂπ≥Âè∞</div>
            </div>
            <div class="home-grid">
                <div class="feature-card" onclick="router.navigate('teachers')">
                    <div class="card-icon"><i class="fa-solid fa-chalkboard-user"></i></div>
                    <div class="card-title">ÊïôÂ∏´ÂàóË°®</div>
                    <div class="card-desc">ÂÖ®Ê†°ÊïôÂ∏´Ë™≤Ë°®Êü•Ë©¢</div>
                </div>
                <div class="feature-card" onclick="router.navigate('classes')">
                    <div class="card-icon"><i class="fa-solid fa-users"></i></div>
                    <div class="card-title">Áè≠Á¥öÂàóË°®</div>
                    <div class="card-desc">ÂêÑÂπ¥Á¥öÁè≠Á¥öË™≤Ë°®Êü•Ë©¢</div>
                </div>
            </div>
            <div style="text-align:center; padding: 20px; color:#94a3b8; font-size:0.8em;">
                Powered by GitHub Pages & Google Apps Script
            </div>
        </div>

        <!-- Teachers List -->
        <div id="page-teachers" class="page-view">
            <div class="container">
                <div class="global-nav">
                    <div class="nav-links">
                        <a onclick="router.navigate('index')">üè† È¶ñÈ†Å</a>
                        <span>/</span>
                        <span class="current">ÊïôÂ∏´ÂàóË°®</span>
                    </div>
                </div>
                <div class="nav-rows-container">
                    <div class="nav-row">
                        <button class="nav-btn active" onclick="filterTeacherList('all', '', this)">ÂÖ®Ê†°‰∫∫Âì°</button>
                        <button class="nav-btn" onclick="filterTeacherList('unit', 'ÊïôÂãôËôï', this)">ÊïôÂãôËôï</button>
                        <button class="nav-btn" onclick="filterTeacherList('unit', 'Â≠∏ÂãôËôï', this)">Â≠∏ÂãôËôï</button>
                        <button class="nav-btn" onclick="filterTeacherList('unit', 'Á∏ΩÂãôËôï', this)">Á∏ΩÂãôËôï</button>
                        <button class="nav-btn" onclick="filterTeacherList('unit', 'ËºîÂ∞éÂÆ§', this)">ËºîÂ∞éÂÆ§</button>
                        <div class="teacher-search-box">üîç <input id="t-search" type="text" class="teacher-search-input"
                                placeholder="ÂßìÂêç..." onkeyup="filterTeacherList(lastFilter.type, lastFilter.val)"></div>
                    </div>
                    <div class="nav-row">
                        <button class="nav-btn" onclick="filterTeacherList('field', 'Ë™ûÊñá', this)">Ë™ûÊñá</button>
                        <button class="nav-btn" onclick="filterTeacherList('field', 'Êï∏Â≠∏', this)">Êï∏Â≠∏</button>
                        <button class="nav-btn" onclick="filterTeacherList('field', 'Ëá™ÁÑ∂', this)">Ëá™ÁÑ∂</button>
                        <button class="nav-btn" onclick="filterTeacherList('field', 'Á§æÊúÉ', this)">Á§æÊúÉ</button>
                        <button class="nav-btn" onclick="filterTeacherList('field', 'ËóùË°ìËàá‰∫∫Êñá', this)">ËóùÊñá</button>
                        <button class="nav-btn" onclick="filterTeacherList('field', 'ÂÅ•È´î', this)">ÂÅ•È´î</button>
                    </div>
                </div>
                <div id="teacher-list-area"></div>
            </div>
        </div>

        <!-- Classes List -->
        <div id="page-classes" class="page-view">
            <div class="container">
                <div class="global-nav">
                    <div class="nav-links">
                        <a onclick="router.navigate('index')">üè† È¶ñÈ†Å</a>
                        <span>/</span>
                        <span class="current">Áè≠Á¥öÂàóË°®</span>
                    </div>
                </div>
                <div id="class-list-area"></div>
            </div>
        </div>

        <!-- Teacher Detail -->
        <div id="page-teacher-detail" class="page-view">
            <div class="container" style="max-width:none; padding:10px; background:transparent; box-shadow:none;">
                <div class="detail-wrapper">
                    <div class="col-cats" id="t-detail-cats"></div>
                    <div class="col-list">
                        <div class="list-search-box"><input id="t-detail-search" type="text" class="list-search-input"
                                placeholder="ÊêúÂ∞ã..." onkeyup="renderDetailTeacherList()"></div>
                        <div id="t-detail-list" class="list-scroll-area"></div>
                    </div>
                    <div class="col-main">
                        <div class="global-nav" style="margin-bottom:10px;">
                            <div class="nav-links">
                                <a onclick="router.navigate('index')">È¶ñÈ†Å</a><span>/</span><a
                                    onclick="router.navigate('teachers')">ÊïôÂ∏´</a>
                            </div>
                            <div style="display:flex; gap:10px;">
                                <a id="adj-link" target="_blank" class="nav-btn" style="text-decoration:none;">‚öôÔ∏è
                                    Ë™ø‰ª£Ë™≤</a>
                                <button class="print-btn" onclick="window.print()">üñ®Ô∏è ÂàóÂç∞</button>
                            </div>
                        </div>
                        <h2 id="t-detail-title" style="text-align:center; margin-bottom:15px;"></h2>
                        <div id="t-detail-tt"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Class Detail -->
        <div id="page-class-detail" class="page-view">
            <div class="container" style="max-width:none; padding:10px; background:transparent; box-shadow:none;">
                <div class="detail-wrapper">
                    <div class="col-class-nav">
                        <div class="class-tabs">
                            <div class="class-tab" onclick="switchGrade('1', this)">‰∏ÄÂπ¥Á¥ö</div>
                            <div class="class-tab" onclick="switchGrade('2', this)">‰∫åÂπ¥Á¥ö</div>
                            <div class="class-tab" onclick="switchGrade('3', this)">‰∏âÂπ¥Á¥ö</div>
                        </div>
                        <div id="c-detail-nav" class="list-scroll-area" style="padding:5px;"></div>
                    </div>
                    <div class="col-main">
                        <div class="global-nav">
                            <div class="nav-links">
                                <a onclick="router.navigate('index')">È¶ñÈ†Å</a><span>/</span><a
                                    onclick="router.navigate('classes')">Áè≠Á¥ö</a>
                            </div>
                            <button class="print-btn" onclick="window.print()">üñ®Ô∏è ÂàóÂç∞</button>
                        </div>
                        <h2 id="c-detail-title" style="text-align:center; margin-bottom:15px;"></h2>
                        <div id="c-detail-tt"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        // --- Core Data & Cache ---
        let DB = null;
        let lastFilter = { type: 'all', val: '' };
        let currentDetailFilter = { type: 'all', val: '' };
        let currentTId = '';
        let currentClassGrade = '1';
        let currentClassCode = '';

        const FECache = {
            get: (k) => JSON.parse(localStorage.getItem('FSJH_V2_' + k) || 'null'),
            set: (k, v) => localStorage.setItem('FSJH_V2_' + k, JSON.stringify(v)),
            clear: () => localStorage.clear()
        };

        function initApp() {
            // Check cache first
            const cached = FECache.get('FULL_DB');
            if (cached && (new Date().getTime() - cached.ts < 3600000 * 6)) { // 6hr TTL
                DB = cached.data;
                console.log('Loaded from cache');
                startRouter();
                // Background sync
                fetchDB(true);
            } else {
                fetchDB();
            }
        }

        function fetchDB(bg = false) {
            if (!bg) document.getElementById('app-loader').style.display = 'flex';

            // Call our Adapter (which calls fetch)
            window.google.script.run.withSuccessHandler(res => {
                if (res) {
                    DB = res;
                    FECache.set('FULL_DB', { ts: new Date().getTime(), data: res });
                    if (!bg) startRouter();
                } else {
                    alert('Ë≥áÊñôÂêåÊ≠•Â§±Êïó');
                }
                document.getElementById('app-loader').style.opacity = '0';
                setTimeout(() => document.getElementById('app-loader').style.display = 'none', 500);
            }).getFullSystemSync();
        }

        function ensureData(cb) {
            if (DB) cb(DB);
            else {
                // Wait for DB (should be handled by initApp, but just in case)
                setTimeout(() => ensureData(cb), 100);
            }
        }

        function startRouter() {
            applySettings();
            // Handle URL params
            const params = new URLSearchParams(window.location.search);
            const page = params.get('page') || 'index';
            const locationStart = {
                parameter: {
                    page: page,
                    id: params.get('id'),
                    code: params.get('code')
                }
            };
            router.load(locationStart.parameter.page, locationStart.parameter);
        }

        function applySettings() {
            if (DB?.settings?.schoolName) document.getElementById('home-school-name').textContent = DB.settings.schoolName + ' Ë™≤Ë°®Êü•Ë©¢Á≥ªÁµ±';
        }

        // --- Router ---
        const router = {
            navigate: function (page, params = {}) {
                window.google.script.history.push(null, params, page);
                this.load(page, params);
                window.scrollTo(0, 0);
            },
            load: function (page, params) {
                document.querySelectorAll('.page-view').forEach(el => el.classList.remove('active'));
                const target = document.getElementById('page-' + page);
                if (target) {
                    target.classList.add('active');
                    if (page === 'teachers') renderTeacherList();
                    if (page === 'classes') renderClassList();
                    if (page === 'teacher_detail') initTeacherDetail(params.id);
                    if (page === 'class_detail') initClassDetail(params.code);
                } else {
                    document.getElementById('page-index').classList.add('active');
                }
            }
        };

        // --- Helper: Get Display Name ---
        function getDispName(t) {
            if (!t) return '';
            const settings = DB.settings || {};
            const mode = settings.mode || 'OFF';
            let name = t.name || t.tname || t.teacher || '';
            let masked = t.maskedName || t.maskedTeacher || '';
            if (!masked && name) masked = name[0] + 'ËÄÅÂ∏´';

            // In API mode, always external unless we implement IP check logic locally
            return mode === 'ALL' ? masked : (mode === 'OFF' ? name : masked);
        }

        // --- View: Teachers List ---
        function renderTeacherList() {
            filterTeacherList(lastFilter.type, lastFilter.val);
        }

        window.filterTeacherList = function (type, val, btn) {
            lastFilter = { type, val };
            if (btn) {
                document.querySelectorAll('#page-teachers .nav-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            const search = (document.getElementById('t-search').value || '').toLowerCase();

            const scheduled = new Set(DB.schedules.map(s => s.tname));

            let list = DB.teachers.filter(t => {
                let match = true;
                if (type !== 'all') {
                    if (type === 'field') match = (t.field && t.field.includes(val));
                    else match = (t[type] === val);
                }
                const dn = getDispName(t);
                return match && dn.toLowerCase().includes(search);
            });

            // Sort
            list.sort((a, b) => (a.category || '').localeCompare(b.category || '') || (a.unit || '').localeCompare(b.unit || ''));

            let html = '<table class="teacher-table"><thead><tr><th>ËÅ∑Á®±</th><th>ÂßìÂêç</th><th>Ë™≤Ë°®</th><th>ÂñÆ‰Ωç</th></tr></thead><tbody>';
            list.forEach(t => {
                const has = scheduled.has(t.name);
                html += `<tr>
                    <td>${t.title}</td>
                    <td>${getDispName(t)}</td>
                    <td>${has ? `<a onclick="router.navigate('teacher_detail',{id:'${t.id}'})" style="cursor:pointer; font-size:1.2em;">üìÖ</a>` : ''}</td>
                    <td>${t.unit}</td>
                </tr>`;
            });
            document.getElementById('teacher-list-area').innerHTML = html + '</tbody></table>';
        }

        // --- View: Classes List ---
        function renderClassList() {
            const classCounts = new Map();
            const classHasCore = new Map();
            DB.schedules.forEach(s => {
                classCounts.set(s.classCode, (classCounts.get(s.classCode) || 0) + 1);
                // Simple heuristic for core class
                if (s.period >= 1 && s.period <= 7) classHasCore.set(s.classCode, true);
            });

            // Unique classes
            const classes = [];
            const processed = new Set();
            DB.schedules.forEach(s => {
                if (!processed.has(s.classCode)) {
                    classes.push({ code: s.classCode, name: s.className });
                    processed.add(s.classCode);
                }
            });

            // Filter valid classes
            const valid = classes.filter(c => classCounts.get(c.code) > 3 && classHasCore.get(c.code))
                .sort((a, b) => a.code.localeCompare(b.code));

            let html = '';
            ['1', '2', '3'].forEach(g => {
                html += `<div class="grade-section"><div class="grade-title">${g}Âπ¥Á¥ö</div><div class="class-grid">`;
                valid.filter(c => c.code.startsWith(g)).forEach(c => {
                    html += `<div class="class-btn" onclick="router.navigate('class_detail',{code:'${c.code}'})">${c.name}</div>`;
                });
                html += `</div></div>`;
            });
            document.getElementById('class-list-area').innerHTML = html;
        }

        // --- View: Teacher Detail ---
        const CATS = [
            { label: 'ÂÖ®Ê†°', type: 'all', val: '' },
            { label: 'ÊïôÂãôËôï', type: 'unit', val: 'ÊïôÂãôËôï' },
            { label: 'Â≠∏ÂãôËôï', type: 'unit', val: 'Â≠∏ÂãôËôï' },
            { label: '‰∏ÄÂπ¥Á¥ö', type: 'unit', val: '‰∏ÄÂπ¥Á¥öÂ∞éÂ∏´' },
            { label: '‰∫åÂπ¥Á¥ö', type: 'unit', val: '‰∫åÂπ¥Á¥öÂ∞éÂ∏´' },
            { label: '‰∏âÂπ¥Á¥ö', type: 'unit', val: '‰∏âÂπ¥Á¥öÂ∞éÂ∏´' },
            { label: 'ÂúãÊñá', type: 'sub', val: 'Ë™ûÊñá' },
            { label: 'Êï∏Â≠∏', type: 'field', val: 'Êï∏Â≠∏' },
            { label: 'Ëá™ÁÑ∂', type: 'field', val: 'Ëá™ÁÑ∂' }
        ];

        function initTeacherDetail(id) {
            currentTId = id;
            document.getElementById('adj-link').href = `${GAS_API_URL.replace('/exec', '')}?page=adjustment&id=${id}`;

            // Render cats
            let catHtml = '';
            CATS.forEach(c => {
                catHtml += `<div class="cat-btn" onclick="filterDetailTeacher('${c.type}','${c.val}', this)">${c.label}</div>`;
            });
            document.getElementById('t-detail-cats').innerHTML = catHtml;

            renderDetailTeacherList();
            if (id) renderTeacherTimetable(id);
        }

        window.filterDetailTeacher = function (type, val, el) {
            currentDetailFilter = { type, val };
            if (el) {
                document.querySelectorAll('#t-detail-cats .cat-btn').forEach(b => b.classList.remove('active'));
                el.classList.add('active');
            }
            renderDetailTeacherList();
        }

        function renderDetailTeacherList() {
            const search = (document.getElementById('t-detail-search').value || '').toLowerCase();
            const scheduled = new Set(DB.schedules.map(s => s.tname));

            // Only show teachers with schedule in detail view
            const list = DB.teachers.filter(t => scheduled.has(t.name)).filter(t => {
                let match = true;
                if (currentDetailFilter.type !== 'all') {
                    if (currentDetailFilter.type === 'sub') match = (t.field === 'Ë™ûÊñá'); // simplified
                    else match = t[currentDetailFilter.type] === currentDetailFilter.val;
                }
                return match && getDispName(t).toLowerCase().includes(search);
            });

            let html = '';
            list.forEach(t => {
                const active = t.id === currentTId ? 'active' : '';
                html += `<div class="list-item ${active}" id="t-item-${t.id}" onclick="router.navigate('teacher_detail',{id:'${t.id}'})">${getDispName(t)}</div>`
            });
            document.getElementById('t-detail-list').innerHTML = html;

            if (currentTId) {
                setTimeout(() => {
                    const el = document.getElementById('t-item-' + currentTId);
                    if (el) el.scrollIntoView({ block: 'center' });
                }, 100);
            }
        }

        function renderTeacherTimetable(id) {
            const t = DB.teachers.find(x => x.id === id);
            if (!t) return;
            const tname = t.name;
            document.getElementById('t-detail-title').textContent = getDispName(t) + ' Ë™≤Ë°®';

            // Build Matrix
            const tt = {};
            DB.schedules.filter(s => s.tname === tname).forEach(s => {
                if (!tt[s.day]) tt[s.day] = {};
                tt[s.day][s.period] = s;
            });

            let html = '<div class="timetable-table-wrap"><table class="timetable-table"><thead><tr><th class="period-label">ÁØÄ</th><th>‰∏Ä</th><th>‰∫å</th><th>‰∏â</th><th>Âõõ</th><th>‰∫î</th></tr></thead><tbody>';
            for (let p = 0; p <= 8; p++) {
                html += `<tr><td class="period-label">${p === 0 ? 'Êó©' : p}</td>`;
                for (let d = 1; d <= 5; d++) {
                    const s = (tt[d] && tt[d][p]) ? tt[d][p] : null;
                    if (s) {
                        html += `<td><div class="subject-name">${s.subjectName}</div><a onclick="router.navigate('class_detail',{code:'${s.classCode}'})" class="link-text">${s.className}</a></td>`;
                    } else {
                        html += '<td></td>';
                    }
                }
                html += '</tr>';
            }
            document.getElementById('t-detail-tt').innerHTML = html + '</tbody></table></div>';
        }

        // --- View: Class Detail ---
        function initClassDetail(code) {
            currentClassCode = code;
            if (code) currentClassGrade = code[0];

            switchGrade(currentClassGrade);
            if (code) renderClassTimetable(code);
        }

        window.switchGrade = function (g, el) {
            currentClassGrade = g;
            document.querySelectorAll('.class-tab').forEach(t => t.classList.remove('active'));
            if (el) el.classList.add('active'); // simplified logic

            const processed = new Set();
            const classes = [];
            DB.schedules.forEach(s => {
                // Simple Count Filter again
                if (!processed.has(s.classCode) && s.classCode.startsWith(g)) {
                    classes.push({ code: s.classCode, name: s.className });
                    processed.add(s.classCode);
                }
            });

            classes.sort((a, b) => a.code.localeCompare(b.code));

            let html = '<div class="class-grid" style="grid-template-columns: repeat(3, 1fr);">';
            classes.forEach(c => {
                const active = c.code === currentClassCode ? 'active' : '';
                html += `<div class="class-btn-mini ${active}" onclick="router.navigate('class_detail',{code:'${c.code}'})">${c.name}</div>`;
            });
            document.getElementById('c-detail-nav').innerHTML = html + '</div>';
        }

        function renderClassTimetable(code) {
            // Find class name
            const sample = DB.schedules.find(s => s.classCode === code);
            const className = sample ? sample.className : code;
            document.getElementById('c-detail-title').textContent = className + ' Ë™≤Ë°®';

            // Build Matrix
            const tt = {};
            DB.schedules.filter(s => s.classCode === code).forEach(s => {
                if (!tt[s.day]) tt[s.day] = {};
                tt[s.day][s.period] = s;
            });

            let html = '<div class="timetable-table-wrap"><table class="timetable-table"><thead><tr><th class="period-label">ÁØÄ</th><th>‰∏Ä</th><th>‰∫å</th><th>‰∏â</th><th>Âõõ</th><th>‰∫î</th></tr></thead><tbody>';
            for (let p = 0; p <= 8; p++) {
                html += `<tr><td class="period-label">${p === 0 ? 'Êó©' : p}</td>`;
                for (let d = 1; d <= 5; d++) {
                    const s = (tt[d] && tt[d][p]) ? tt[d][p] : null;
                    if (s) {
                        const teacherDisp = getDispName({ name: s.tname, maskedName: s.maskedTeacher });
                        html += `<td><div class="subject-name">${s.subjectName}</div><a onclick="router.navigate('teacher_detail',{id:'${s.tid}'})" class="link-text">${teacherDisp}</a></td>`;
                    } else {
                        html += '<td></td>';
                    }
                }
                html += '</tr>';
            }
            document.getElementById('c-detail-tt').innerHTML = html + '</tbody></table></div>';
        }

        // --- Start ---
        window.addEventListener('load', initApp);

    </script>
</body>

</html>